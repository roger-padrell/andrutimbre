<html>
  <head>
    <title>Andrutimbre - Andruino team</title>
  </head>
  <body>
    <button onclick="await connect()">Connect</button>
  </body>
  <script>
    class Arduino {
    constructor() {
        this.port = null;
        this.reader = null;
        this.writer = null;
    }

    async open() {
        // Request a port and open the connection
        this.port = await navigator.serial.requestPort();
        await this.port.open({ baudRate: 9600 });

        // Create a writer and a reader
        this.writer = this.port.writable.getWriter();
        this.reader = this.port.readable.getReader();
    }

    async send(message) {
        // Send the message with a newline
        const msgWithNewline = message + "\n";
        const encoder = new TextEncoder();
        await this.writer.write(encoder.encode(msgWithNewline));

        // Read the response
        const response = await this.readResponse();
        return response;
    }

    async readResponse() {
        let response = '';
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await this.reader.read();
            if (done) break;

            // Decode the received data
            response += decoder.decode(value, { stream: true });

            // Check if the response ends with 'end_message'
            if (response.endsWith('end_message')) {
                // Remove 'end_message' from the response
                response = response.slice(0, -12); // 12 is the length of 'end_message'
                break;
            }
        }

        return response;
    }

    async close() {
        // Close the writer and reader, and the port
        if (this.writer) {
            await this.writer.releaseLock();
        }
        if (this.reader) {
            await this.reader.releaseLock();
        }
        await this.port.close();
    }
}
    window.connected = false;
    async function connect(){
      window.device = new Arduino();
      await device.open()
      if((await device.send("HELLO")) == "OLLEH"){
         alert("Connection succesful");
          window.connected = true;
      } 
      else{
        alert("Connection error");
      }
    }
  </script>
</html>
