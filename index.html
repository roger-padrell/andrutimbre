<html>
  <head>
    <title>Andrutimbre - Andruino team</title>
  </head>
  <body>
    
  </body>
  <script>
    async function sendToArduino(message) {
  const TERMINATOR = "end_message";

  // Request the serial port
  const port = await navigator.serial.requestPort();

  try {
    // Open port at 9600 baud
    await port.open({ baudRate: 9600 });

    // Wait a moment for Arduino to reset
    await new Promise(r => setTimeout(r, 500));

    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    const writer = port.writable.getWriter();
    const reader = port.readable.getReader();

    let buffer = "";

    try {
      // 1️⃣ Flush any existing incoming data
      const flushStart = Date.now();
      while (Date.now() - flushStart < 100) {
        const { value, done } = await reader.read();
        if (done || !value) break;
      }

      // 2️⃣ Send the message (append newline for Arduino convenience)
      await writer.write(encoder.encode(message + "\n"));

      // 3️⃣ Read until TERMINATOR
      buffer = "";
      while (true) {
        const { value, done } = await reader.read();
        if (done) {
          throw new Error("Serial port closed before terminator received");
        }

        buffer += decoder.decode(value, { stream: true });

        const endIndex = buffer.indexOf(TERMINATOR);
        if (endIndex !== -1) {
          // Return everything before terminator
          return buffer.slice(0, endIndex).trim();
        }
      }

    } finally {
      reader.releaseLock();
      writer.releaseLock();
    }

  } finally {
    await port.close();
  }
}
  </script>
</html>
